name: update conda lockfile
on:
  push:
    branches:
      - main
      - dev
    paths:
      - .github/workflows/create-conda-lock.yml
      - ci/environment.yml
  pull_request:
    branches:
      - main
      - dev
    paths:
      - .github/workflows/create-conda-lock.yml
      - ci/environment.yml
  workflow_dispatch:
permissions:
  contents: write
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: checkout repo
      uses: actions/checkout@main
    - name: install conda-lock with micromamba
      uses: mamba-org/setup-micromamba@main
      with:
        environment-name: locker
        create-args: conda-lock
        cache-environment: true
    - name: run conda-lock
      shell: bash -el {0}
      working-directory: ci
      run: |
        conda-lock lock --mamba --file environment.yml --platform linux-64
    - name: commit changes to tracked files
      env: 
        GH_TOKEN: ${{ secrets.UPDATE_LOCKFILE_TOKEN }}
      run: |
        if [[ $(git ls-files --modified) ]]; then
          git config --global user.name 'ateucher'
          git config --global user.email 'andy.teucher@gmail.com'
          git checkout $GITHUB_REF_NAME  # or the correct branch variable
          git commit --all --message "[bot] autogenerated conda-lock files"
          git push origin $GITHUB_REF_NAME
          fi
        fi
